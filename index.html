<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TOYROCK ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³ & æŠ•ç¥¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  margin:20px;
  background:#0f172a;
  color:#e5e7eb;
}
h1,h2{ margin-top:1.5em }
hr{ border:0; border-top:1px solid #334155 }
button{
  margin:4px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
  background:#2563eb;
  color:white;
  cursor:pointer;
}
button:disabled{
  opacity:.4;
  cursor:not-allowed;
}
input,select{
  padding:6px;
  border-radius:6px;
  border:1px solid #475569;
  background:#020617;
  color:#e5e7eb;
}
ul{ padding-left:1em }
li{ margin:6px 0 }
small{ color:#94a3b8 }
</style>
</head>

<body>

<h1>ğŸ¸ TOYROCK ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³</h1>
<div id="countdown"></div>

<hr>

<h2>â‘  æŠ•ç¥¨</h2>
<input id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
<br><br>
<select id="songSelect"></select>
<br>
<button onclick="vote()">æŠ•ç¥¨ã™ã‚‹</button>
<div id="voteMsg"></div>

<hr>

<h2>â‘¡ ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³ (<span id="cnt">0</span>/20)</h2>
<ul id="myset"></ul>
<button onclick="exportCSV()">CSVå‡ºåŠ›</button>
<button onclick="shareX()">Xã§å…±æœ‰</button>

<hr>

<h2>â‘¢ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
<ul id="rank"></ul>

<script>
/* ========= è¨­å®š ========= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxRzLTTPdkB7yOc8XeNrQzNEBQ6NyM0P8SkA8rUR6RNJqgdS_4YGrfMhsuv1RkBVMXHnA/exec";
const DEADLINE = new Date("2026-03-22T18:00:00+09:00");
const MAX_SETLIST = 20;

/* ========= æ›²ãƒ‡ãƒ¼ã‚¿ï¼ˆç¢ºå®šç‰ˆï¼‰ ========= */
const ALBUMS = [
  {
    name:"THE EARLY TOYBEE",
    color:"#FFD700",
    songs:[
      "å…¨ç±³ã¯æ³£ã‹ãªã„","ãã‚Œã‚†ã‘!å¤¢ã¿ã‚‹ã‚¾ãƒ³ãƒ“ãƒ¼ã‚º!!","Flight Music",
      "é›»è„³ãƒ´ã‚£ã‚¸ãƒ©ãƒ³ãƒ†","é»æ˜ã‚°ãƒƒãƒ‰ãƒ«ãƒ¼ã‚¶ãƒ¼","ã‚ã‚‰ã—ã®ã‚ˆã‚‹ã«",
      "ã„ãªã›","ã‚ã»ã‚“ã ã‚‰ã„ãµ"
    ]
  },
  {
    name:"REVIVAL",
    color:"#8B5CF6",
    songs:[
      "æƒ‘æ˜Ÿãƒ€ãƒ–ãƒªã‚¹","Super Imagination","ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ©ãƒ´ã‚¡ãƒ¼",
      "é¢¨çŸ¥ã‚‰ã¬ã²ã¨","ãƒ•ãƒ­ãƒ ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ãƒ³ãƒ‰",
      "Teenage Black","ã‚·ãƒ¼ãƒ©ã‚«ãƒ³ã‚¹ã¨æ–‡å­¦"
    ]
  },
  {
    name:"LOOKBACK TO THE FUTURE",
    color:"#06B6D4",
    songs:[
      "LOOKBACK","Golden Age","ã‚¹ãƒ†ãƒ«ã‚ªãƒ³ãƒŠ",
      "é“åŒ–å¸«ã®ãƒ©ãƒ–ã‚½ãƒ³ã‚°","ãƒ©ã‚¤ãƒ‰ãƒ»ã‚¢ãƒ³ãƒ‰ãƒ»ãƒ©ã‚¤ãƒ–",
      "S.Y.S -Save Your Souls-","TO THE FUTURE"
    ]
  },
  {
    name:"TOYROCK INVASION",
    color:"#EF4444",
    songs:[
      "TOY ROCK -TOYBEEã®ãƒ†ãƒ¼ãƒ-","ã‚·ãƒ¢ã‚­ã‚¿ãƒ»ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ»ãƒ–ãƒ«ãƒ¼ã‚¹",
      "CAT GIRL","Jonnie's Rock'n'Roll Lamp","Playlist in your Heart"
    ]
  },
  {
    name:"Singles",
    color:"#F59E0B",
    songs:["ã²ã¨ã¤ã ã‘","ãƒãƒŠãƒãƒ«"]
  }
];

const SONGS = ALBUMS.flatMap(a=>a.songs);

/* ========= å…±é€š ========= */
const qs=id=>document.getElementById(id);
const today=new Date().toISOString().slice(0,10);
const load=k=>JSON.parse(localStorage.getItem(k)||"null");
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ========= ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ========= */
function tick(){
  const d=DEADLINE-new Date();
  if(d<=0){ qs("countdown").textContent="â° æŠ•ç¥¨çµ‚äº†"; lockUI(); return; }
  const h=Math.floor(d/36e5),
        m=Math.floor(d%36e5/6e4),
        s=Math.floor(d%6e4/1e3);
  qs("countdown").textContent=`â³ æ®‹ã‚Š ${h}h ${m}m ${s}s`;
}
setInterval(tick,1000); tick();

/* ========= æŠ•ç¥¨æ›²é¸æŠ ========= */
qs("songSelect").innerHTML =
  ALBUMS.map(a=>
    `<optgroup label="${a.name}">
      ${a.songs.map(s=>`<option value="${s}">${s}</option>`).join("")}
     </optgroup>`
  ).join("");

/* ========= ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¿æŒ ========= */
const savedNick=localStorage.getItem("nickname_"+today);
if(savedNick) qs("nickname").value=savedNick;

/* ========= API ========= */
async function apiPost(body){
  const r=await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  return r.json();
}

/* ========= æŠ•ç¥¨ ========= */
async function vote(){
  if(new Date()>DEADLINE) return;
  const nick=qs("nickname").value.trim();
  if(!nick){ alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¿…é ˆ"); return; }

  if(localStorage.getItem("nickname_"+today)){
    qs("voteMsg").textContent="æœ¬æ—¥ã¯ã“ã®åå‰ã§ç™»éŒ²æ¸ˆã¿";
    return;
  }

  const song=qs("songSelect").value;

  try{
    await apiPost({action:"vote",nickname:nick,song});
    localStorage.setItem("nickname_"+today,nick);
    const v=load("votes")||{};
    v[today]=song;
    save("votes",v);
    qs("voteMsg").textContent="æŠ•ç¥¨å®Œäº†";
    loadMySet();
    loadRank();
  }catch{
    qs("voteMsg").textContent="æŠ•ç¥¨ã‚¨ãƒ©ãƒ¼";
  }
}

/* ========= ãƒã‚¤ã‚»ãƒˆãƒª ========= */
function loadMySet(){
  const votes=load("votes")||{};
  let list=load("myset")||[];
  Object.values(votes).forEach(s=>{
    if(!list.includes(s)&&list.length<MAX_SETLIST) list.push(s);
  });
  save("myset",list);
  renderMySet();
}

function move(i,d){
  const l=load("myset")||[];
  const j=i+d;
  if(j<0||j>=l.length) return;
  [l[i],l[j]]=[l[j],l[i]];
  save("myset",l);
  renderMySet();
}

function renderMySet(){
  const l=load("myset")||[];
  qs("cnt").textContent=l.length;
  qs("myset").innerHTML=l.map((s,i)=>`
    <li>${i+1}. ${s}
      <button onclick="move(${i},-1)">â†‘</button>
      <button onclick="move(${i},1)">â†“</button>
    </li>
  `).join("");
}

/* ========= CSV ========= */
function exportCSV(){
  const l=load("myset")||[];
  const csv=l.map((s,i)=>`${i+1},${s}`).join("\n");
  const blob=new Blob(["é †ä½,æ›²å\n"+csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="my_setlist.csv";
  a.click();
}

/* ========= Xå…±æœ‰ ========= */
function shareX(){
  const l=load("myset")||[];
  const text=
    "#toybeeãƒªã‚­ãƒƒãƒ‰\nãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³\n"+
    l.map((s,i)=>`${i+1}. ${s}`).join("\n")+
    "\n\n"+location.href;
  window.open(
    "https://twitter.com/intent/tweet?text="+encodeURIComponent(text),
    "_blank"
  );
}

/* ========= ãƒ©ãƒ³ã‚­ãƒ³ã‚° ========= */
async function loadRank(){
  try{
    const r=await fetch(GAS_URL+"?action=rank");
    const d=await r.json();
    qs("rank").innerHTML=d.map(x=>`<li>${x.song}ï¼š${x.count}</li>`).join("");
  }catch{
    qs("rank").innerHTML="<li>å–å¾—ã‚¨ãƒ©ãƒ¼</li>";
  }
}

/* ========= ç· åˆ‡å¾Œãƒ­ãƒƒã‚¯ ========= */
function lockUI(){
  document.querySelectorAll("button,input,select")
    .forEach(e=>e.disabled=true);
}

/* ========= åˆæœŸåŒ– ========= */
loadMySet();
loadRank();
</script>

</body>
</html>
