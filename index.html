<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ROAD TO TOYROCK INVASION</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0f172a;
  --card:#1e1b2e;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#facc15;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:var(--text);
}
header{
  text-align:center;
  padding:40px 16px;
}
h1{margin:0;font-size:36px}
#countdown{font-size:26px;margin-top:12px}
.desc{max-width:900px;margin:20px auto;color:var(--muted);font-size:14px}

main{
  display:flex;
  gap:16px;
  padding:24px;
}
section{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  flex:1;
}
h2{margin-top:0}

input[type=text]{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-bottom:12px;
}

.album{margin-bottom:10px}
.album summary{
  cursor:pointer;
  font-weight:700;
  margin-bottom:6px;
}

/* ★ 安定レイアウト */
.song{
  display:grid;
  grid-template-columns: 24px 1fr;
  gap:10px;
  padding:6px 4px;
  align-items:start;
}
.song span{
  line-height:1.5;
  word-break:break-word;
}

button{
  margin-top:12px;
  background:var(--accent);
  border:none;
  border-radius:999px;
  padding:8px 14px;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#334155;
  color:#fff;
}
button.small{
  margin-top:0;
  padding:6px 10px;
  border-radius:10px;
  font-weight:700;
}
button.ghost{
  background:#334155;
  color:#fff;
}

small{color:var(--muted)}
ul{padding-left:18px}
ol{padding-left:20px;margin:0}

.myrow{
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 0;
}
.mytitle{
  flex:1;
  line-height:1.5;
  word-break:break-word;
}
.note{
  color:var(--muted);
  font-size:12px;
  margin-top:8px;
}

table{
  width:100%;
  border-collapse:collapse;
  overflow:hidden;
  border-radius:12px;
}
th,td{
  padding:10px 12px;
  border-bottom:1px solid rgba(148,163,184,0.25);
  text-align:left;
  vertical-align:top;
}
th{
  color:var(--muted);
  font-size:12px;
  letter-spacing:.05em;
  text-transform:uppercase;
}
tr:last-child td{border-bottom:none}
.rankcol{width:72px;white-space:nowrap}

/* DnD */
.dragging{opacity:.5}
.drop-target{outline:2px dashed rgba(250,204,21,.8); outline-offset:6px; border-radius:12px;}
.handle{cursor:grab; user-select:none; padding:4px 8px; border-radius:10px; background:#334155; color:#fff; font-weight:700;}
.handle:active{cursor:grabbing;}

@media(max-width:900px){
  main{flex-direction:column}
}
</style>
</head>

<body>

<header>
  <h1>ROAD TO TOYROCK INVASION</h1>
  <div id="countdown"></div>
  <div class="desc">
    このページはロックバンドtoybeeの2026/3/22(日)＠恵比寿リキッドルーム ワンマンライブの成功を祈念して、toybeeファンが作成したものです。<br>
    ※toybee公式とは関係ありませんのでご留意ください。
    <br><br>
    ・1日1人5票まで<br>
    ・マイセトリ最大20曲<br>
    ・ランキングは全員の累積
    <br><br>
    <small>※ 現在はテストモード（local保存）</small>
  </div>
</header>

<main>

<!-- 投票 -->
<section>
  <h2>① 投票（最大5曲）</h2>
  <input id="nickname" type="text" placeholder="ニックネーム" oninput="render()">

  <div id="songList"></div>

<button onclick="vote()">テスト投票</button>
<button class="small ghost" style="margin-left:8px;" onclick="postTodayVotesToX()">本日の投票をXに投稿</button>
<button class="secondary" style="margin-left:8px;" onclick="resetTest()">テストデータ全消去</button>


  <div id="voteMsg" class="note"></div>
</section>

<!-- マイセトリ（2番目） -->
<section>
  <h2>② マイセトリ（最大20曲）</h2>

<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
  <button class="small ghost" onclick="clearMySet()">マイセトリを空にする</button>
</div>


  <ol id="myset"></ol>
  <div id="mysetMsg" class="note"></div>
</section>

<!-- ランキング（表・同率同順位・票数非公開） -->
<section>
  <h2>③ ランキング（テスト）</h2>
  <table>
    <thead>
      <tr>
        <th class="rankcol">順位</th>
        <th>曲名</th>
      </tr>
    </thead>
    <tbody id="rank"></tbody>
  </table>
</section>

</main>

<script>
/* ===== 設定 ===== */
const DEADLINE = new Date("2026-03-22T18:00:00+09:00");
const MAX_VOTE = 5;      // 1回のチェック上限
const MAX_DAILY = 5;     // 1日合計の上限（←今回ここを厳密化）
const MAX_MYSET = 20;

/* X投稿 末尾URL（指定） */
const X_SHORT_URL = "https://x.gd/qATK1";

/* ===== 曲データ ===== */
const ALBUMS=[
  {name:"THE EARLY TOYBEE",songs:["全米は泣かない","それゆけ!夢みるゾンビーズ!!","Flight Music","電脳ヴィジランテ","黎明グッドルーザー","あらしのよるに","いなせ","あほんだらいふ"]},
  {name:"REVIVAL",songs:["惑星ダブリス","Super Imagination","ワンタイムラヴァー","風知らぬひと","フロムアンダーランド","Teenage Black","シーラカンスと文学"]},
  {name:"LOOKBACK TO THE FUTURE",songs:["LOOKBACK","Golden Age","ステルオンナ","道化師のラブソング","ライド・アンド・ライブ","S.Y.S -Save Your Souls-","TO THE FUTURE"]},
  {name:"TOYROCK INVASION",songs:["TOY ROCK -TOYBEEのテーマ-","シモキタ・モーニング・ブルース","CAT GIRL","Jonnie's Rock'n'Roll Lamp","Playlist in your Heart"]},
  {name:"Singles",songs:["ひとつだけ","ハナマル"]}
];

/* ===== カウントダウン ===== */
function tick(){
  const d = DEADLINE - new Date();
  if(d<=0){ countdown.textContent="開演しました"; return; }
  const s=Math.floor(d/1000);
  countdown.textContent =
    "ライブ開演まであと "+
    String(Math.floor(s/86400)).padStart(2,"0")+":"+
    String(Math.floor(s%86400/3600)).padStart(2,"0")+":"+
    String(Math.floor(s%3600/60)).padStart(2,"0")+":"+
    String(s%60).padStart(2,"0");
}
setInterval(tick,1000); tick();

/* ===== 曲描画 ===== */
const songList = document.getElementById("songList");
ALBUMS.forEach(a=>{
  const d=document.createElement("details");
  d.className="album";
  d.innerHTML=`<summary>${a.name}</summary>`;
  a.songs.forEach(s=>{
    d.innerHTML += `
      <label class="song">
        <input type="checkbox" value="${escapeHtml(s)}" onchange="limitCheck()">
        <span>${escapeHtml(s)}</span>
      </label>`;
  });
  songList.appendChild(d);
});

/* ===== HTMLエスケープ（安全対策） ===== */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== 制限（1回のチェック数） ===== */
function limitCheck(){
  const c=[...document.querySelectorAll("input[type=checkbox]:checked")];
  if(c.length>MAX_VOTE){
    c[c.length-1].checked=false;
    alert("最大5曲までです");
  }
}

/* ===== localStorage ヘルパ ===== */
function loadVotes(){
  return JSON.parse(localStorage.getItem("testVotes")||"{}");
}
function saveVotes(data){
  localStorage.setItem("testVotes", JSON.stringify(data));
}

/* ===== 日付キー（JST固定） ===== */
function todayKeyJST(){
  const now = new Date();
  const jst = new Date(now.getTime() + 9*60*60*1000);
  const y = jst.getUTCFullYear();
  const m = String(jst.getUTCMonth()+1).padStart(2,"0");
  const d = String(jst.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function dailyStorageKey(){
  return `dailyVotes_${todayKeyJST()}`;
}
function loadDailyVotes(){
  return JSON.parse(localStorage.getItem(dailyStorageKey())||"{}");
}
function saveDailyVotes(data){
  localStorage.setItem(dailyStorageKey(), JSON.stringify(data));
}

/* ===== マイセトリ（ニックネーム単位） ===== */
function getNick(){
  return nickname.value.trim();
}
function getMySet(nick){
  const data = loadVotes();
  const arr = Array.isArray(data[nick]) ? data[nick] : [];
  // 重複除去しつつ順序維持
  const seen = new Set();
  const uniq = [];
  for(const s of arr){
    if(!seen.has(s)){
      seen.add(s);
      uniq.push(s);
    }
  }
  return uniq.slice(0, MAX_MYSET);
}
function setMySet(nick, list){
  const data = loadVotes();
  data[nick] = list.slice(0, MAX_MYSET);
  saveVotes(data);
}

/* ===== 本日の投票ログ（ニックネーム単位） ===== */
function getTodayVotesRaw(nick){
  const d = loadDailyVotes();
  return Array.isArray(d[nick]) ? d[nick] : [];
}
function addDailyVotes(nick, selected){
  const d = loadDailyVotes();
  const cur = Array.isArray(d[nick]) ? d[nick] : [];

  // 1日合計MAX_DAILYまでに切る（念のため）
  const merged = cur.concat(selected).slice(0, MAX_DAILY);

  d[nick] = merged;
  saveDailyVotes(d);
}
function getTodayVotesForTweet(nick){
  // “その日に投票した内容”をそのまま、最大5曲
  return getTodayVotesRaw(nick).slice(0, MAX_DAILY);
}

/* ===== テスト投票 ===== */
function vote(){
  const nick = getNick();
  if(!nick){ alert("ニックネーム必須"); return; }

  const selected = [...document.querySelectorAll("input[type=checkbox]:checked")].map(c=>c.value);
  if(!selected.length){ alert("曲を選んでください"); return; }

  // --- 1日合計5票の厳密チェック ---
  const todayAlready = getTodayVotesRaw(nick).length;
  const remain = MAX_DAILY - todayAlready;
  if(remain <= 0){
    alert("本日の投票はすでに5票に達しています。");
    return;
  }
  if(selected.length > remain){
    alert(`本日の残り投票枠は ${remain} 曲です。選び直してください。`);
    return;
  }

  // 1) 本日の投票ログへ追加（順序保持）
  addDailyVotes(nick, selected);

  // 2) マイセトリへも反映（従来どおり）
  const current = getMySet(nick);
  const merged = current.concat(selected);

  const seen = new Set();
  const uniq = [];
  for(const s of merged){
    if(!seen.has(s)){
      seen.add(s);
      uniq.push(s);
    }
  }
  setMySet(nick, uniq);

  voteMsg.textContent = `テスト投票しました（本日の投票：${todayKeyJST()} / ${getTodayVotesRaw(nick).length}票）`;

  // 投票後にチェック解除
  document.querySelectorAll("input[type=checkbox]:checked").forEach(el=>el.checked=false);

  render();
}

/* ===== マイセトリ：クリア ===== */
function clearMySet(){
  const nick = getNick();
  if(!nick){ alert("先にニックネームを入力してください"); return; }
  if(confirm("このニックネームのマイセトリを空にしますか？")){
    setMySet(nick, []);
    render();
  }
}

/* ===== X投稿（本日の投票内容：最大5曲） ===== */
function buildTodayVotesXText(){
  const nick = getNick();
  const voted = nick ? getTodayVotesForTweet(nick) : [];

  const lines = [
    "私がマイセトリに入れたい曲はこちら！",
    ...voted,
    "#toybee #toybeeリキッド",
    X_SHORT_URL
  ];
  return lines.join("\n");
}

function postTodayVotesToX(){
  const nick = getNick();
  if(!nick){ alert("先にニックネームを入力してください"); return; }

  const voted = getTodayVotesForTweet(nick);
  if(voted.length === 0){
    alert("本日の投票内容がありません。まず投票してください。");
    return;
  }

  const text = buildTodayVotesXText();
  const url = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(text);
  window.open(url, "_blank", "noopener,noreferrer");
}

/* ===== ランキング生成（全員累積・同率同順位・票数非公開） ===== */
function computeRanking(){
  const data = loadVotes();
  const counts = {};

  Object.values(data).forEach(arr=>{
    (arr||[]).forEach(s=>{
      counts[s] = (counts[s]||0) + 1;
    });
  });

  const entries = Object.entries(counts).sort((a,b)=>{
    if(b[1] !== a[1]) return b[1] - a[1];
    return String(a[0]).localeCompare(String(b[0]), "ja");
  });

  // 同率同順位（1,1,3...）
  const ranked = [];
  let prevCount = null;
  let rank = 0;
  let index = 0;

  for(const [song, c] of entries){
    index += 1;
    if(prevCount === null || c !== prevCount){
      rank = index;
      prevCount = c;
    }
    ranked.push({ rank, song, count:c });
  }
  return ranked;
}

/* ===== DnD（マイセトリ曲順入れ替え） ===== */
let dragFromIdx = null;

function onDragStart(e){
  const li = e.currentTarget;
  dragFromIdx = Number(li.dataset.idx);
  li.classList.add("dragging");
  e.dataTransfer.effectAllowed = "move";
}

function onDragOver(e){
  e.preventDefault();
  e.currentTarget.classList.add("drop-target");
  e.dataTransfer.dropEffect = "move";
}

function onDragLeave(e){
  e.currentTarget.classList.remove("drop-target");
}

function onDrop(e){
  e.preventDefault();
  const toIdx = Number(e.currentTarget.dataset.idx);
  e.currentTarget.classList.remove("drop-target");

  const nick = getNick();
  if(!nick) return;
  const list = getMySet(nick);

  if(dragFromIdx === null || toIdx === dragFromIdx) return;
  if(dragFromIdx < 0 || dragFromIdx >= list.length) return;
  if(toIdx < 0 || toIdx >= list.length) return;

  const [item] = list.splice(dragFromIdx, 1);
  list.splice(toIdx, 0, item);

  setMySet(nick, list);
  dragFromIdx = null;
  render();
}

function onDragEnd(e){
  e.currentTarget.classList.remove("dragging");
  document.querySelectorAll(".drop-target").forEach(el=>el.classList.remove("drop-target"));
}

/* ===== 表示 ===== */
function render(){
  // --- ランキング ---
  const ranked = computeRanking();
  rank.innerHTML = ranked.map(r=>`
    <tr>
      <td class="rankcol">${r.rank}位</td>
      <td>${escapeHtml(r.song)}</td>
    </tr>
  `).join("");

  // --- マイセトリ ---
  const nick = getNick();
  const mysetEl = document.getElementById("myset");
  const mymsg = document.getElementById("mysetMsg");

  if(!nick){
    mysetEl.innerHTML = "";
    mymsg.textContent = "ニックネームを入力すると、あなたのマイセトリを表示・並べ替えできます。";
    return;
  }

  const list = getMySet(nick);
  if(list.length === 0){
    mysetEl.innerHTML = "";
    mymsg.textContent = "マイセトリは空です。投票で追加できます。";
    return;
  }

  const todayCount = getTodayVotesRaw(nick).length;
  mymsg.textContent =
    `≡ をドラッグ&ドロップで曲順を変更できます（保存されます）。`+
    `X投稿は「本日の投票内容（${todayKeyJST()} / ${todayCount}票）」をそのまま最大5曲載せます。`;

  mysetEl.innerHTML = list.map((s, i)=>`
    <li draggable="true" data-idx="${i}"
        ondragstart="onDragStart(event)"
        ondragover="onDragOver(event)"
        ondragleave="onDragLeave(event)"
        ondrop="onDrop(event)"
        ondragend="onDragEnd(event)">
      <div class="myrow">
        <span class="handle" title="ドラッグして並べ替え">≡</span>
        <div class="mytitle">${escapeHtml(s)}</div>
      </div>
    </li>
  `).join("");
}
render();

/* ===== リセット ===== */
function resetTest(){
  if(confirm("テストデータを全削除しますか？")){
    localStorage.removeItem("testVotes");
    localStorage.removeItem(dailyStorageKey()); // 今日の分も消す
    voteMsg.textContent = "";
    render();
  }
}
</script>

</body>
</html>
