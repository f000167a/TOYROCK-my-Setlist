<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TOYROCK ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: system-ui, sans-serif; margin:20px; }
h1,h2 { margin-top:1.5em }
button { margin-left:6px }
ul { padding-left:1em }
li { margin:6px 0 }
select,input { padding:4px }
small { color:#666 }
</style>
</head>

<body>

<h1>ğŸ¸ TOYROCK ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³</h1>
<div id="countdown"></div>

<hr>

<h2>â‘  æŠ•ç¥¨</h2>
<input id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">

<select id="songSelect"></select>
<button onclick="vote()">æŠ•ç¥¨</button>
<div id="voteMsg"></div>

<hr>

<h2>â‘¡ ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³ (<span id="cnt">0</span>/20)</h2>
<ul id="myset"></ul>

<button onclick="downloadCSV()">ğŸ“„ CSVå‡ºåŠ›</button>
<button onclick="shareX()">ğŸ¦ Xã§å…±æœ‰</button>

<hr>

<h2>â‘¢ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
<ul id="rank"></ul>

<script>
/* ===== è¨­å®š ===== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxRzLTTPdkB7yOc8XeNrQzNEBQ6NyM0P8SkA8rUR6RNJqgdS_4YGrfMhsuv1RkBVMXHnA/exec";
const DEADLINE = new Date("2026-03-22T18:00:00+09:00");
const MAX = 20;

const SONGS = [
  "æ›²A","æ›²B","æ›²C","æ›²D","æ›²E",
  "æ›²F","æ›²G","æ›²H","æ›²I","æ›²J"
];

/* ===== å…±é€š ===== */
const qs=id=>document.getElementById(id);
const today=new Date().toISOString().slice(0,10);
const load=k=>JSON.parse(localStorage.getItem(k)||"null");
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===== æ›²ãƒªã‚¹ãƒˆ ===== */
SONGS.forEach(s=>{
  const o=document.createElement("option");
  o.value=o.textContent=s;
  qs("songSelect").appendChild(o);
});

/* ===== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ===== */
function tick(){
  const d=DEADLINE-new Date();
  if(d<=0){ qs("countdown").textContent="â° æŠ•ç¥¨çµ‚äº†"; return; }
  qs("countdown").textContent=`â³ æ®‹ã‚Š ${Math.floor(d/36e5)}h`;
}
setInterval(tick,1000); tick();

/* ===== æŠ•ç¥¨ ===== */
async function vote(){
  const nick=qs("nickname").value.trim();
  const song=qs("songSelect").value;
  if(!nick||!song){alert("æœªå…¥åŠ›");return;}

  const voted=load("votes")||{};
  if(voted[today]){ qs("voteMsg").textContent="æœ¬æ—¥æŠ•ç¥¨æ¸ˆã¿";return;}

  let myset=load("myset")||[];

  if(!myset.includes(song)){
    if(myset.length<MAX){
      myset.push(song);
    }else{
      const remove=prompt("20æ›²ã‚ã‚Šã¾ã™ã€‚å…¥ã‚Œæ›¿ãˆã‚‹æ›²åã‚’å…¥åŠ›");
      const idx=myset.indexOf(remove);
      if(idx===-1){ alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
      myset[idx]=song;
    }
    save("myset",myset);
  }

  voted[today]=song;
  save("votes",voted);
  qs("voteMsg").textContent="æŠ•ç¥¨å®Œäº†";
  renderMySet();
}

/* ===== ãƒã‚¤ã‚»ãƒˆãƒª ===== */
function move(i,d){
  const l=load("myset")||[];
  const j=i+d;
  if(j<0||j>=l.length)return;
  [l[i],l[j]]=[l[j],l[i]];
  save("myset",l);
  renderMySet();
}

function renderMySet(){
  const l=load("myset")||[];
  qs("cnt").textContent=l.length;
  qs("myset").innerHTML=l.map((s,i)=>`
    <li>${i+1}. ${s}
    <button onclick="move(${i},-1)">â†‘</button>
    <button onclick="move(${i},1)">â†“</button>
    </li>`).join("");
}
renderMySet();

/* ===== CSV ===== */
function downloadCSV(){
  const l=load("myset")||[];
  let csv="é †ä½,æ›²å\n"+l.map((s,i)=>`${i+1},${s}`).join("\n");
  const b=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="my_setlist.csv";
  a.click();
}

/* ===== Xå…±æœ‰ ===== */
function shareX(){
  const l=load("myset")||[];
  const text="#TOYROCK\nãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³\n"+l.map((s,i)=>`${i+1}. ${s}`).join("\n");
  const url="https://twitter.com/intent/tweet?text="+encodeURIComponent(text);
  window.open(url,"_blank");
}
</script>

</body>
</html>
