<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TOYROCK ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³ & æŠ•ç¥¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: system-ui, sans-serif; margin:20px; }
h1,h2 { margin-top:1.5em }
button { margin:2px }
ul { padding-left:1em }
li { margin:4px 0 }
small { color:#666 }
.disabled { opacity:.5; pointer-events:none }
</style>
</head>

<body>

<h1>ğŸ¸ TOYROCK ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³</h1>
<div id="countdown"></div>

<hr>

<h2>â‘  æŠ•ç¥¨</h2>
<input id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
<button onclick="vote()">æŠ•ç¥¨ã™ã‚‹</button>
<div id="voteMsg"></div>

<hr>

<h2>â‘¡ ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³ (<span id="cnt">0</span>/20)</h2>
<ul id="myset"></ul>

<hr>

<h2>â‘¢ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
<ul id="rank"></ul>

<script>
/* ========= è¨­å®š ========= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxRzLTTPdkB7yOc8XeNrQzNEBQ6NyM0P8SkA8rUR6RNJqgdS_4YGrfMhsuv1RkBVMXHnA/exec";
const DEADLINE = new Date("2026-03-22T18:00:00+09:00");
const MAX_SETLIST = 20;
const SONGS = [
  "æ›²A","æ›²B","æ›²C","æ›²D","æ›²E",
  "æ›²F","æ›²G","æ›²H","æ›²I","æ›²J"
];

/* ========= å…±é€š ========= */
const qs = id => document.getElementById(id);
const today = new Date().toISOString().slice(0,10);

/* ========= ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ========= */
function tick(){
  const diff = DEADLINE - new Date();
  if(diff<=0){ qs("countdown").textContent="â° æŠ•ç¥¨çµ‚äº†"; return; }
  const h=Math.floor(diff/36e5),
        m=Math.floor(diff%36e5/6e4),
        s=Math.floor(diff%6e4/1e3);
  qs("countdown").textContent=`â³ æ®‹ã‚Š ${h}h ${m}m ${s}s`;
}
setInterval(tick,1000); tick();

/* ========= localStorage ========= */
const load = k => JSON.parse(localStorage.getItem(k)||"null");
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ========= æŠ•ç¥¨ ========= */
async function apiPost(body){
  const r = await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  return r.json();
}

async function vote(){
  const nick = qs("nickname").value.trim();
  if(!nick){ alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¿…é ˆ"); return; }

  const voted = load("votes")||{};
  if(voted[today]){ qs("voteMsg").textContent="æœ¬æ—¥ã¯æŠ•ç¥¨æ¸ˆã¿"; return; }

  const song = prompt("æŠ•ç¥¨ã™ã‚‹æ›²åã‚’å…¥åŠ›");
  if(!song) return;

  try{
    await apiPost({ action:"vote", nickname:nick, song });
    voted[today] = song;
    save("votes", voted);
    qs("voteMsg").textContent="æŠ•ç¥¨å®Œäº†";
    loadMySet();
    loadRank();
  }catch(e){
    qs("voteMsg").textContent="æŠ•ç¥¨ã‚¨ãƒ©ãƒ¼";
  }
}

/* ========= ãƒã‚¤ã‚»ãƒˆãƒª ========= */
function loadMySet(){
  const votes = load("votes")||{};
  let list = load("myset")||[];

  Object.values(votes).forEach(s=>{
    if(!list.includes(s) && list.length<MAX_SETLIST){
      list.push(s);
    }
  });

  save("myset", list);
  renderMySet();
}

function move(i,d){
  const list = load("myset")||[];
  const j=i+d;
  if(j<0||j>=list.length) return;
  [list[i],list[j]]=[list[j],list[i]];
  save("myset",list);
  renderMySet();
}

function renderMySet(){
  const list = load("myset")||[];
  qs("cnt").textContent=list.length;
  qs("myset").innerHTML=list.map((s,i)=>`
    <li>${s}
      <button onclick="move(${i},-1)">â†‘</button>
      <button onclick="move(${i},1)">â†“</button>
    </li>`).join("");
}

/* ========= ãƒ©ãƒ³ã‚­ãƒ³ã‚° ========= */
async function loadRank(){
  try{
    const r = await fetch(GAS_URL+"?action=rank");
    const data = await r.json();
    qs("rank").innerHTML=data.map(d=>`<li>${d.song}ï¼š${d.count}</li>`).join("");
  }catch{
    qs("rank").innerHTML="<li>ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼</li>";
  }
}

/* ========= åˆæœŸåŒ– ========= */
loadMySet();
loadRank();
</script>

</body>
</html>
