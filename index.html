%%writefile index.html
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROAD TO TOYROCK INVASION</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  min-height:100vh;
  background:linear-gradient(135deg,#0a0a1a 0%,#0f172a 40%,#1a0a2e 100%);
  color:#e2e8f0;
  font-family:'Helvetica Neue','Segoe UI',sans-serif;
  overflow-x:hidden;
}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#334155;border-radius:99px}

/* Floating bees */
.bee{position:fixed;font-size:20px;opacity:.25;pointer-events:none;animation:fd 8s linear infinite}
@keyframes fd{0%{transform:translateY(-30px) rotate(0);opacity:0}10%{opacity:.25}90%{opacity:.25}100%{transform:translateY(105vh) rotate(360deg);opacity:0}}
@keyframes si{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* Header */
.header{text-align:center;padding:24px 16px 0}
.road{font-size:13px;color:#64748b;letter-spacing:4px;text-transform:uppercase}
.title{font-size:26px;font-weight:900;background:linear-gradient(135deg,#FFD700,#F59E0B,#EF4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:4px 0;letter-spacing:2px}
.subtitle{font-size:12px;color:#94a3b8}
.user-info{font-size:10px;color:#475569;margin-top:4px}
.user-info button{background:none;border:none;color:#64748b;cursor:pointer;font-size:10px;text-decoration:underline;margin-left:4px}

/* Countdown */
.cd-wrap{display:flex;justify-content:center;gap:8px;padding:20px 16px 16px}
.cd-box{background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid #FFD700;border-radius:12px;padding:10px 12px;min-width:60px;text-align:center;box-shadow:0 0 20px rgba(255,215,0,.2),inset 0 0 20px rgba(255,215,0,.05)}
.cd-num{font-size:28px;font-weight:800;color:#FFD700;font-family:monospace;letter-spacing:2px;text-shadow:0 0 10px rgba(255,215,0,.5)}
.cd-label{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:2px;display:block;margin-top:4px}
.cd-colon{color:#FFD700;font-size:24px;font-weight:700;padding-top:10px;transition:opacity .3s}

/* Description */
.desc{max-width:500px;margin:0 auto 12px;text-align:center;font-size:11px;color:#475569;line-height:1.7;padding:0 16px}

/* Tabs */
.tabs{display:flex;justify-content:center;gap:6px;padding:0 16px 16px}
.tab{padding:8px 20px;border-radius:99px;border:none;font-size:13px;font-weight:600;cursor:pointer;background:rgba(255,255,255,.05);color:#94a3b8;transition:all .2s}
.tab.active{background:linear-gradient(135deg,#FFD700,#F59E0B);color:#000;box-shadow:0 4px 15px rgba(255,215,0,.3)}

/* Content area */
.content{padding:0 16px 24px;max-width:560px;margin:0 auto}
.card{background:rgba(255,255,255,.02);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,.05);margin-bottom:16px;animation:si .3s ease}

/* Nickname screen */
.nick-screen{min-height:100vh;display:flex;align-items:center;justify-content:center}
.nick-box{text-align:center;padding:32px;max-width:360px}
.nick-input{width:100%;padding:12px 16px;border-radius:10px;border:2px solid rgba(255,215,0,.25);background:rgba(255,255,255,.05);color:#e2e8f0;font-size:15px;outline:none;text-align:center;margin-bottom:12px}
.nick-input:focus{border-color:rgba(255,215,0,.6)}
.nick-btn{width:100%;padding:12px 0;border-radius:10px;border:none;background:linear-gradient(135deg,#FFD700,#F59E0B);color:#000;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(255,215,0,.3)}

/* Section header */
.sec-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.sec-title{font-size:16px;font-weight:700;color:#e2e8f0}
.badge{font-size:12px;font-weight:700;padding:4px 12px;border-radius:99px}
.badge-gold{color:#FFD700;background:rgba(255,215,0,.1)}
.badge-red{color:#EF4444;background:rgba(239,68,68,.1)}

/* Album filter */
.filters{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px}
.filter-btn{padding:4px 12px;border-radius:99px;border:none;font-size:11px;cursor:pointer;font-weight:600;transition:all .2s}

/* Song item in vote */
.song-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.05);background:rgba(255,255,255,.02);margin-bottom:6px;transition:all .2s}
.song-item.voted{background:rgba(255,215,0,.08);border-color:rgba(255,215,0,.3)}
.song-info{flex:1;min-width:0}
.song-name{font-size:13px;color:#e2e8f0;font-weight:500;word-break:break-word}
.song-album{font-size:10px;padding:2px 8px;border-radius:99px;margin-left:6px;white-space:nowrap}
.vote-btn{border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;min-width:70px;text-align:center;transition:all .2s}
.vote-btn.on{background:linear-gradient(135deg,#FFD700,#F59E0B);color:#000}
.vote-btn.off{background:rgba(255,255,255,.06);color:#e2e8f0}
.vote-btn.disabled{background:rgba(255,255,255,.03);color:#475569;cursor:default}

/* Ranking */
.rank-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;margin-bottom:6px}
.rank-row.top3{background:rgba(255,215,0,.05);border:1px solid rgba(255,215,0,.15)}
.rank-row.normal{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05)}
.rank-num{font-size:16px;font-weight:800;min-width:28px}
.rank-bar-bg{height:6px;border-radius:99px;background:rgba(255,255,255,.06);overflow:hidden;margin-top:4px}
.rank-bar{height:100%;border-radius:99px;transition:width .5s}
.rank-voters{font-size:10px;color:#475569;margin-top:2px}

/* My setlist */
.my-row{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;margin-bottom:4px;border:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.02);transition:all .15s}
.my-row.encore{background:rgba(255,215,0,.06);border-color:rgba(255,215,0,.15)}
.my-num{color:#64748b;font-size:12px;min-width:28px;font-weight:700}
.my-row.encore .my-num{color:#FFD700}
.my-title{flex:1;font-size:13px;color:#e2e8f0;word-break:break-word}
.my-handle{cursor:grab;user-select:none;padding:2px 6px;border-radius:6px;background:rgba(255,255,255,.06);color:#64748b;font-weight:700;font-size:12px}
.my-handle:active{cursor:grabbing}
.my-rm{background:none;border:none;cursor:pointer;color:#EF4444;font-size:13px;padding:2px}
.dragging{opacity:.4}
.drop-target{outline:2px dashed rgba(250,204,21,.7);outline-offset:2px;border-radius:8px}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#FFD700;color:#000;padding:10px 24px;border-radius:99px;font-size:13px;font-weight:600;z-index:9999;box-shadow:0 4px 20px rgba(255,215,0,.4);animation:si .3s ease;pointer-events:none}

/* Footer buttons */
.foot-btns{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px}
.btn-sm{padding:6px 14px;border-radius:8px;border:none;font-size:11px;font-weight:600;cursor:pointer}
.btn-x{background:rgba(29,161,242,.15);color:#1DA1F2;border:1px solid rgba(29,161,242,.3)}
.btn-clear{background:rgba(239,68,68,.1);color:#EF4444;border:1px solid rgba(239,68,68,.25)}
.btn-reset{background:rgba(255,255,255,.05);color:#64748b;border:1px solid rgba(255,255,255,.08)}

/* Accordion */
details{background:rgba(255,255,255,.02);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,.05)}
summary{color:#FFD700;font-size:14px;font-weight:700;cursor:pointer;list-style:none}
summary::-webkit-details-marker{display:none}

/* Timeline */
.tl{position:relative;padding-left:20px;margin-top:12px}
.tl-line{position:absolute;left:8px;top:8px;bottom:8px;width:2px;background:linear-gradient(to bottom,#FFD700,#EF4444)}
.tl-item{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;position:relative}
.tl-dot{position:absolute;left:-16px;top:6px;border-radius:50%;border:2px solid #0f172a}
.tl-date{font-size:11px;color:#64748b;font-family:monospace}
.tl-cap{font-size:10px;padding:1px 6px;border-radius:4px;margin-left:6px}
.tl-label{font-size:13px;margin-left:6px}

.empty{text-align:center;padding:30px;color:#475569;font-size:13px;border:2px dashed rgba(255,255,255,.08);border-radius:12px}

@media(max-width:400px){
  .cd-box{min-width:50px;padding:8px 10px}
  .cd-num{font-size:22px}
  .tab{padding:7px 14px;font-size:12px}
}
</style>
</head>
<body>

<!-- Nickname Screen -->
<div id="nickScreen" class="nick-screen">
  <div class="nick-box">
    <div style="font-size:48px;margin-bottom:16px">ğŸ</div>
    <div class="title" style="font-size:24px;margin-bottom:8px">TOYROCK INVASION</div>
    <p style="color:#94a3b8;font-size:13px;margin-bottom:24px">2026.3.22 æµæ¯”å¯¿LIQUIDROOM<br>ã‚»ãƒˆãƒªæŠ•ç¥¨ã«å‚åŠ ã—ã‚ˆã†ï¼</p>
    <input id="nickInput" class="nick-input" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" maxlength="20">
    <button class="nick-btn" onclick="enterApp()">ğŸ å‚åŠ ã™ã‚‹</button>
    <p style="color:#475569;font-size:11px;margin-top:8px">â€»ç©ºæ¬„ãªã‚‰ã€Œåç„¡ã—ã‚¯ãƒ«ãƒ¼ã€ã§å‚åŠ </p>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" style="display:none">
  <!-- Floating bees -->
  <div class="bee" style="left:5%;animation-delay:0s">ğŸ</div>
  <div class="bee" style="left:17%;animation-delay:2s">ğŸ</div>
  <div class="bee" style="left:29%;animation-delay:4s">ğŸ</div>
  <div class="bee" style="left:41%;animation-delay:6s">ğŸ</div>
  <div class="bee" style="left:53%;animation-delay:1s">ğŸ</div>
  <div class="bee" style="left:65%;animation-delay:3s">ğŸ</div>
  <div class="bee" style="left:77%;animation-delay:5s">ğŸ</div>
  <div class="bee" style="left:89%;animation-delay:7s">ğŸ</div>

  <!-- Header -->
  <div class="header">
    <div class="road">ROAD TO</div>
    <div class="title">TOYROCK INVASION</div>
    <div class="subtitle">2026.3.22 (SUN) æµæ¯”å¯¿LIQUIDROOM</div>
    <div class="user-info">ğŸ <span id="dispNick"></span>ã•ã‚“ã€ã‚ˆã†ã“ãï¼<button onclick="changeNick()">å¤‰æ›´</button></div>
  </div>

  <!-- Countdown -->
  <div class="cd-wrap">
    <div><div class="cd-box"><span class="cd-num" id="cdD">00</span></div><span class="cd-label">DAYS</span></div>
    <div class="cd-colon" id="col1">:</div>
    <div><div class="cd-box"><span class="cd-num" id="cdH">00</span></div><span class="cd-label">HRS</span></div>
    <div class="cd-colon" id="col2">:</div>
    <div><div class="cd-box"><span class="cd-num" id="cdM">00</span></div><span class="cd-label">MIN</span></div>
    <div class="cd-colon" id="col3">:</div>
    <div><div class="cd-box"><span class="cd-num" id="cdS">00</span></div><span class="cd-label">SEC</span></div>
  </div>

  <!-- Description -->
  <div class="desc">
    toybeeãƒ•ã‚¡ãƒ³ãŒä½œæˆã—ãŸéå…¬å¼å¿œæ´ãƒšãƒ¼ã‚¸ã§ã™ï¼ˆtoybeeå…¬å¼ã¨ã¯ç„¡é–¢ä¿‚ã§ã™ï¼‰<br>
    1æ—¥5ç¥¨ã¾ã§ ï¼ ãƒã‚¤ã‚»ãƒˆãƒªæœ€å¤§20æ›² ï¼ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯å…¨å“¡ã®ç´¯ç©
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="vote" onclick="switchTab('vote')">ğŸ¸ æŠ•ç¥¨</button>
    <button class="tab" data-tab="ranking" onclick="switchTab('ranking')">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    <button class="tab" data-tab="setlist" onclick="switchTab('setlist')">ğŸ“‹ ãƒã‚¤ã‚»ãƒˆãƒª</button>
  </div>

  <!-- Content -->
  <div class="content">

    <!-- Vote Tab -->
    <div id="tabVote" class="card"></div>

    <!-- Ranking Tab -->
    <div id="tabRanking" class="card" style="display:none"></div>

    <!-- Setlist Tab -->
    <div id="tabSetlist" class="card" style="display:none"></div>

    <!-- Timeline -->
    <details>
      <summary>ğŸš€ toybeeã®è»Œè·¡ â”€â”€ LIQUIDROOMã¸ã®é“ â–¾</summary>
      <div class="tl">
        <div class="tl-line"></div>
        <div class="tl-item"><div class="tl-dot" style="width:10px;height:10px;background:hsl(0,70%,55%)"></div><div><div><span class="tl-date">2021.09</span><span class="tl-cap" style="color:#94a3b8;background:rgba(255,255,255,.04)">~50äºº</span></div><span class="tl-label" style="color:#e2e8f0">åˆãƒ©ã‚¤ãƒ–</span><span style="font-size:11px;color:#64748b;margin-left:6px">Sound Stream sakura</span></div></div>
        <div class="tl-item"><div class="tl-dot" style="width:10px;height:10px;background:hsl(40,70%,55%)"></div><div><div><span class="tl-date">2022.07</span><span class="tl-cap" style="color:#94a3b8;background:rgba(255,255,255,.04)">~200äºº</span></div><span class="tl-label" style="color:#e2e8f0">åˆãƒ¯ãƒ³ãƒãƒ³</span><span style="font-size:11px;color:#64748b;margin-left:6px">ä¸‹åŒ—æ²¢SHELTER</span></div></div>
        <div class="tl-item"><div class="tl-dot" style="width:10px;height:10px;background:hsl(80,70%,55%)"></div><div><div><span class="tl-date">2023.04</span></div><span class="tl-label" style="color:#e2e8f0">1st Album</span><span style="font-size:11px;color:#64748b;margin-left:6px">THE EARLY TOYBEE</span></div></div>
        <div class="tl-item"><div class="tl-dot" style="width:10px;height:10px;background:hsl(120,70%,55%)"></div><div><div><span class="tl-date">2023.10</span><span class="tl-cap" style="color:#94a3b8;background:rgba(255,255,255,.04)">~300äºº</span></div><span class="tl-label" style="color:#e2e8f0">ãƒ¯ãƒ³ãƒãƒ³</span><span style="font-size:11px;color:#64748b;margin-left:6px">ä¸‹åŒ—æ²¢CLUB Que</span></div></div>
        <div class="tl-item"><div class="tl-dot" style="width:10px;height:10px;background:hsl(160,70%,55%)"></div><div><div><span class="tl-date">2024.02</span><span class="tl-cap" style="color:#94a3b8;background:rgba(255,255,255,.04)">~500äºº</span></div><span class="tl-label" style="color:#e2e8f0">ãƒ¯ãƒ³ãƒãƒ³</span><span style="font-size:11px;color:#64748b;margin-left:6px">æ–°å®¿LOFT</span></div></div>
        <div class="tl-item"><div class="tl-dot" style="width:10px;height:10px;background:hsl(200,70%,55%)"></div><div><div><span class="tl-date">2025.01</span><span class="tl-cap" style="color:#94a3b8;background:rgba(255,255,255,.04)">~600äºº</span></div><span class="tl-label" style="color:#e2e8f0">SOLD OUT!</span><span style="font-size:11px;color:#64748b;margin-left:6px">æ¸‹è°·CLUB QUATTRO</span></div></div>
        <div class="tl-item"><div class="tl-dot" style="width:10px;height:10px;background:hsl(240,70%,55%)"></div><div><div><span class="tl-date">2026.01</span></div><span class="tl-label" style="color:#e2e8f0">EP Release</span><span style="font-size:11px;color:#64748b;margin-left:6px">TOYROCK INVASION</span></div></div>
        <div class="tl-item"><div class="tl-dot" style="width:14px;height:14px;background:#FFD700;box-shadow:0 0 12px rgba(255,215,0,.6)"></div><div><div><span class="tl-date">2026.03</span><span class="tl-cap" style="color:#FFD700;background:rgba(255,215,0,.1)">~1000äºº</span></div><span class="tl-label" style="color:#FFD700;font-weight:700">ğŸ NEXT!</span><span style="font-size:11px;color:#64748b;margin-left:6px">æµæ¯”å¯¿LIQUIDROOM</span></div></div>
      </div>
    </details>
  </div>

  <div style="text-align:center;padding:8px 16px 20px;font-size:10px;color:#334155">Made with ğŸ for TOYROCK INVASION @ LIQUIDROOM 2026.3.22</div>
</div>

<!-- Toast -->
<div id="toast" class="toast" style="display:none"></div>

<script>
/* ===== Config ===== */
const DEADLINE=new Date("2026-03-22T18:00:00+09:00");
const MAX_VOTE=5;
const MAX_DAILY=5;
const MAX_MYSET=20;
const X_SHORT_URL="https://x.gd/qATK1";

const ALBUMS=[
  {name:"THE EARLY TOYBEE",color:"#FFD700",songs:["å…¨ç±³ã¯æ³£ã‹ãªã„","ãã‚Œã‚†ã‘!å¤¢ã¿ã‚‹ã‚¾ãƒ³ãƒ“ãƒ¼ã‚º!!","Flight Music","é›»è„³ãƒ´ã‚£ã‚¸ãƒ©ãƒ³ãƒ†","é»æ˜ã‚°ãƒƒãƒ‰ãƒ«ãƒ¼ã‚¶ãƒ¼","ã‚ã‚‰ã—ã®ã‚ˆã‚‹ã«","ã„ãªã›","ã‚ã»ã‚“ã ã‚‰ã„ãµ"]},
  {name:"REVIVAL",color:"#8B5CF6",songs:["æƒ‘æ˜Ÿãƒ€ãƒ–ãƒªã‚¹","Super Imagination","ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ©ãƒ´ã‚¡ãƒ¼","é¢¨çŸ¥ã‚‰ã¬ã²ã¨","ãƒ•ãƒ­ãƒ ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ãƒ³ãƒ‰","Teenage Black","ã‚·ãƒ¼ãƒ©ã‚«ãƒ³ã‚¹ã¨æ–‡å­¦"]},
  {name:"LOOKBACK TO THE FUTURE",color:"#06B6D4",songs:["LOOKBACK","Golden Age","ã‚¹ãƒ†ãƒ«ã‚ªãƒ³ãƒŠ","é“åŒ–å¸«ã®ãƒ©ãƒ–ã‚½ãƒ³ã‚°","ãƒ©ã‚¤ãƒ‰ãƒ»ã‚¢ãƒ³ãƒ‰ãƒ»ãƒ©ã‚¤ãƒ–","S.Y.S -Save Your Souls-","TO THE FUTURE"]},
  {name:"TOYROCK INVASION",color:"#EF4444",songs:["TOY ROCK -TOYBEEã®ãƒ†ãƒ¼ãƒ-","ã‚·ãƒ¢ã‚­ã‚¿ãƒ»ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ»ãƒ–ãƒ«ãƒ¼ã‚¹","CAT GIRL","Jonnie's Rock'n'Roll Lamp","Playlist in your Heart"]},
  {name:"Singles",color:"#F59E0B",songs:["ã²ã¨ã¤ã ã‘","ãƒãƒŠãƒãƒ«"]}
];
const ALL_SONGS=ALBUMS.flatMap(a=>a.songs.map(s=>({title:s,album:a.name,color:a.color})));

/* ===== Utils ===== */
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}
function todayJST(){const n=new Date(),j=new Date(n.getTime()+9*36e5);return j.toISOString().split("T")[0]}
function loadVotes(){return JSON.parse(localStorage.getItem("testVotes")||"{}")}
function saveVotes(d){localStorage.setItem("testVotes",JSON.stringify(d))}
function loadDaily(){return JSON.parse(localStorage.getItem("daily_"+todayJST())||"{}")}
function saveDaily(d){localStorage.setItem("daily_"+todayJST(),JSON.stringify(d))}

let currentNick="";
let currentTab="vote";
let currentFilter="all";
let toastTimer=null;

/* ===== Toast ===== */
function showToast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg;el.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{el.style.display="none"},2500);
}

/* ===== Nickname ===== */
function enterApp(){
  const v=document.getElementById("nickInput").value.trim()||"åç„¡ã—ã‚¯ãƒ«ãƒ¼";
  localStorage.setItem("toybee_nick",v);
  currentNick=v;
  document.getElementById("nickScreen").style.display="none";
  document.getElementById("mainApp").style.display="block";
  document.getElementById("dispNick").textContent=v;
  renderAll();
}
function changeNick(){
  localStorage.removeItem("toybee_nick");
  currentNick="";
  document.getElementById("nickScreen").style.display="flex";
  document.getElementById("mainApp").style.display="none";
  document.getElementById("nickInput").value="";
}
// Auto-login
(function(){
  const saved=localStorage.getItem("toybee_nick");
  if(saved){
    currentNick=saved;
    document.getElementById("nickScreen").style.display="none";
    document.getElementById("mainApp").style.display="block";
    document.getElementById("dispNick").textContent=saved;
  }
  document.getElementById("nickInput").addEventListener("keydown",e=>{if(e.key==="Enter")enterApp()});
})();

/* ===== Countdown ===== */
function tick(){
  const d=DEADLINE-new Date();
  if(d<=0){document.getElementById("cdD").textContent="00";return}
  const s=Math.floor(d/1000);
  const sec=s%60;
  document.getElementById("cdD").textContent=String(Math.floor(s/86400)).padStart(2,"0");
  document.getElementById("cdH").textContent=String(Math.floor(s%86400/3600)).padStart(2,"0");
  document.getElementById("cdM").textContent=String(Math.floor(s%3600/60)).padStart(2,"0");
  document.getElementById("cdS").textContent=String(sec).padStart(2,"0");
  const op=sec%2===0?1:.3;
  document.getElementById("col1").style.opacity=op;
  document.getElementById("col2").style.opacity=op;
  document.getElementById("col3").style.opacity=op;
}
setInterval(tick,1000);tick();

/* ===== Tabs ===== */
function switchTab(id){
  currentTab=id;
  document.querySelectorAll(".tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===id)});
  document.getElementById("tabVote").style.display=id==="vote"?"block":"none";
  document.getElementById("tabRanking").style.display=id==="ranking"?"block":"none";
  document.getElementById("tabSetlist").style.display=id==="setlist"?"block":"none";
  renderAll();
}

/* ===== Data helpers ===== */
function getMySet(){
  const d=loadVotes(),a=d[currentNick]||[];
  const seen=new Set(),u=[];
  for(const s of a){if(!seen.has(s)){seen.add(s);u.push(s)}}
  return u.slice(0,MAX_MYSET);
}
function setMySet(list){const d=loadVotes();d[currentNick]=list.slice(0,MAX_MYSET);saveVotes(d)}
function getTodayVotes(){const d=loadDaily();return d[currentNick]||[]}
function addTodayVotes(songs){const d=loadDaily();const c=d[currentNick]||[];d[currentNick]=c.concat(songs).slice(0,MAX_DAILY);saveDaily(d)}

/* ===== Vote rendering ===== */
function renderVote(){
  const el=document.getElementById("tabVote");
  const today=getTodayVotes();
  const remain=MAX_DAILY-today.length;

  // Header
  let html=`<div class="sec-header">
    <span class="sec-title">ğŸ¸ è´ããŸã„æ›²ã«æŠ•ç¥¨</span>
    <span class="badge ${remain>0?"badge-gold":"badge-red"}">æ®‹ã‚Š ${remain}/5ç¥¨</span>
  </div>`;

  // Filters
  html+=`<div class="filters">
    <button class="filter-btn" style="background:${currentFilter==="all"?"#FFD700":"rgba(255,255,255,.06)"};color:${currentFilter==="all"?"#000":"#94a3b8"}" onclick="currentFilter='all';renderVote()">ALL</button>`;
  ALBUMS.forEach(a=>{
    const active=currentFilter===a.name;
    html+=`<button class="filter-btn" style="background:${active?a.color:"rgba(255,255,255,.06)"};color:${active?"#000":"#94a3b8"}" onclick="currentFilter='${esc(a.name)}';renderVote()">${a.name==="Singles"?"Singles":a.name.split(" ")[0]}</button>`;
  });
  html+=`</div>`;

  // Songs
  const filtered=currentFilter==="all"?ALL_SONGS:ALL_SONGS.filter(s=>s.album===currentFilter);
  filtered.forEach(s=>{
    const voted=today.includes(s.title);
    const cls=voted?"voted":"";
    const btnCls=voted?"on":remain<=0?"disabled":"off";
    const btnTxt=voted?"âœ“ æ¨ã—":"ğŸ æŠ•ç¥¨";
    const dis=(!voted&&remain<=0)?'disabled':'';
    html+=`<div class="song-item ${cls}">
      <div class="song-info">
        <span class="song-name">${esc(s.title)}</span>
        <span class="song-album" style="color:${s.color};background:${s.color}15">${esc(s.album)}</span>
      </div>
      <button class="vote-btn ${btnCls}" ${dis} onclick="toggleVote('${esc(s.title)}')">${btnTxt}</button>
    </div>`;
  });

  // Footer buttons
  html+=`<div class="foot-btns">
    <button class="btn-sm btn-x" onclick="postToX()">ğ• æœ¬æ—¥ã®æŠ•ç¥¨ã‚’ãƒã‚¹ãƒˆ</button>
    <button class="btn-sm btn-reset" onclick="resetAll()">ğŸ—‘ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å…¨æ¶ˆå»</button>
  </div>`;

  el.innerHTML=html;
}

/* ===== Toggle vote ===== */
function toggleVote(title){
  const today=getTodayVotes();
  if(today.includes(title)){
    // Unvote
    const d=loadDaily();
    d[currentNick]=(d[currentNick]||[]).filter(s=>s!==title);
    saveDaily(d);
    // Remove from myset too
    const ms=getMySet().filter(s=>s!==title);
    setMySet(ms);
    showToast("ğŸ—‘ å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
  }else{
    if(today.length>=MAX_DAILY){showToast("âš  ä»Šæ—¥ã®æŠ•ç¥¨ä¸Šé™ï¼ˆ5ç¥¨ï¼‰ã«é”ã—ã¾ã—ãŸ");return}
    addTodayVotes([title]);
    // Add to myset
    const ms=getMySet();
    if(!ms.includes(title))ms.push(title);
    setMySet(ms);
    showToast("ğŸ æŠ•ç¥¨ã—ã¾ã—ãŸï¼");
  }
  renderAll();
}

/* ===== Ranking ===== */
function renderRanking(){
  const el=document.getElementById("tabRanking");
  const data=loadVotes();
  const counts={};
  Object.values(data).forEach(arr=>{(arr||[]).forEach(s=>{counts[s]=(counts[s]||0)+1})});
  const entries=Object.entries(counts).sort((a,b)=>b[1]-a[1]||a[0].localeCompare(b[0],"ja"));

  const ranked=[];
  let prev=null,rank=0,idx=0;
  for(const[song,c]of entries){idx++;if(prev===null||c!==prev){rank=idx;prev=c}ranked.push({rank,song,count:c})}
  const mx=ranked.length>0?ranked[0].count:1;

  let html=`<div class="sec-header">
    <span class="sec-title">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
    <button class="btn-sm btn-reset" style="margin:0" onclick="renderRanking()">â†» æ›´æ–°</button>
  </div>`;

  if(ranked.length===0){
    html+=`<div class="empty">ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ä¸€ç¥¨ã‚’ï¼</div>`;
  }else{
    ranked.forEach((r,i)=>{
      const song=ALL_SONGS.find(s=>s.title===r.song)||{color:"#94a3b8"};
      const pct=mx>0?(r.count/mx)*100:0;
      const cls=i<3?"top3":"normal";
      const numColor=i===0?"#FFD700":i===1?"#C0C0C0":i===2?"#CD7F32":"#64748b";
      html+=`<div class="rank-row ${cls}">
        <span class="rank-num" style="color:${numColor}">${r.rank}</span>
        <div style="flex:1">
          <span class="song-name">${esc(r.song)}</span>
          <div class="rank-bar-bg"><div class="rank-bar" style="width:${pct}%;background:linear-gradient(90deg,${song.color},${song.color}88)"></div></div>
        </div>
      </div>`;
    });
  }
  el.innerHTML=html;
}

/* ===== My Setlist ===== */
function renderSetlist(){
  const el=document.getElementById("tabSetlist");
  const today=getTodayVotes();
  const list=getMySet();

  let html=`<div style="margin-bottom:20px">
    <span class="sec-title">ğŸ—³ ä»Šæ—¥ã®æŠ•ç¥¨ï¼ˆ${today.length}ç¥¨ï¼‰</span>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">`;
  if(today.length===0)html+=`<span style="color:#475569;font-size:13px">ã¾ã æŠ•ç¥¨ã—ã¦ã„ã¾ã›ã‚“</span>`;
  else today.forEach(t=>{const s=ALL_SONGS.find(x=>x.title===t);html+=`<span style="padding:4px 12px;border-radius:99px;font-size:12px;color:${s?s.color:"#e2e8f0"};background:${(s?s.color:"#FFD700")}15;border:1px solid ${(s?s.color:"#FFD700")}33">${esc(t)}</span>`});
  html+=`</div></div>`;

  html+=`<div class="sec-header">
    <span class="sec-title">ğŸ¤ ãƒã‚¤ã‚»ãƒˆãƒªäºˆæƒ³ (${list.length}/${MAX_MYSET})</span>
    <button class="btn-sm btn-clear" onclick="clearMySet()">ç©ºã«ã™ã‚‹</button>
  </div>`;

  if(list.length===0){
    html+=`<div class="empty">æŠ•ç¥¨ã™ã‚‹ã¨è‡ªå‹•ã§ãƒã‚¤ã‚»ãƒˆãƒªã«è¿½åŠ ã•ã‚Œã¾ã™</div>`;
  }else{
    list.forEach((title,i)=>{
      const enc=i>=list.length-2&&list.length>5;
      html+=`<div class="my-row ${enc?"encore":""}" draggable="true" data-idx="${i}"
        ondragstart="dStart(event)" ondragover="dOver(event)" ondragleave="dLeave(event)" ondrop="dDrop(event)" ondragend="dEnd(event)">
        <span class="my-handle" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ">â‰¡</span>
        <span class="my-num">${enc?"En.":(i+1)+"."}</span>
        <span class="my-title">${esc(title)}</span>
        <button class="my-rm" onclick="rmFromSet(${i})">âœ•</button>
      </div>`;
    });
  }

  html+=`<div class="foot-btns" style="margin-top:16px">
    <button class="btn-sm btn-x" onclick="postToX()">ğ• æœ¬æ—¥ã®æŠ•ç¥¨ã‚’ãƒã‚¹ãƒˆ</button>
  </div>`;
  html+=`<div style="font-size:10px;color:#475569;margin-top:8px">â‰¡ ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§æ›²é †ã‚’å¤‰æ›´ã§ãã¾ã™</div>`;

  el.innerHTML=html;
}

/* ===== DnD ===== */
let dragIdx=null;
function dStart(e){dragIdx=+e.currentTarget.dataset.idx;e.currentTarget.classList.add("dragging");e.dataTransfer.effectAllowed="move"}
function dOver(e){e.preventDefault();e.currentTarget.classList.add("drop-target")}
function dLeave(e){e.currentTarget.classList.remove("drop-target")}
function dDrop(e){e.preventDefault();e.currentTarget.classList.remove("drop-target");const to=+e.currentTarget.dataset.idx;if(dragIdx===null||dragIdx===to)return;const l=getMySet();const[item]=l.splice(dragIdx,1);l.splice(to,0,item);setMySet(l);dragIdx=null;renderSetlist()}
function dEnd(e){e.currentTarget.classList.remove("dragging");document.querySelectorAll(".drop-target").forEach(el=>el.classList.remove("drop-target"))}

function rmFromSet(i){const l=getMySet();l.splice(i,1);setMySet(l);renderSetlist()}
function clearMySet(){if(confirm("ãƒã‚¤ã‚»ãƒˆãƒªã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ")){setMySet([]);renderSetlist()}}

/* ===== X Post ===== */
function postToX(){
  const today=getTodayVotes();
  if(!today.length){showToast("âš  ã¾ãšæŠ•ç¥¨ã—ã¦ãã ã•ã„");return}
  const lines=["ç§ãŒãƒã‚¤ã‚»ãƒˆãƒªã«å…¥ã‚ŒãŸã„æ›²ã¯ã“ã¡ã‚‰ï¼",...today,"#toybee #toybeeãƒªã‚­ãƒƒãƒ‰",X_SHORT_URL];
  window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(lines.join("\n")),"_blank","noopener,noreferrer");
}

/* ===== Reset ===== */
function resetAll(){
  if(confirm("ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.removeItem("testVotes");
    localStorage.removeItem("daily_"+todayJST());
    showToast("ğŸ—‘ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    renderAll();
  }
}

/* ===== Render all ===== */
function renderAll(){renderVote();renderRanking();renderSetlist()}
renderAll();
</script>
</body>
</html>
